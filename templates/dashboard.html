{% load i18n %}
{% load staticfiles %}

<html ng-app="App">
  <head>
    <title>Sauron Brought You Some Cookies</title>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <style type="text/css">
      .messages-wrapper {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 300px;
      }
      .sidebar {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        z-index: 1000;
        display: block;
        padding: 20px;
        overflow-x: auto;
        overflow-y: auto;
        background-color: #f5f5f5;
        border-right: 1px solid #eee;
      }
      .filebrowser {
        margin-top: 10px;
        margin-right: -21px;
        margin-bottom: 20px;
        margin-left: -20px;
      }
      .filebrowser ul, .filebrowser li {
        display: block;
        list-style: none;
        padding: 0;
        margin-left: 10px;
      }
      .directory {
        color: #5F4C0B;
      }
      .file {
        color: #0B610B;
      }
      .editor-wrapper {
        position: fixed;
        top: 10px;
        bottom: 0;
        right: 0;
        left: 235px;
        z-index: 1000;
        display: block;
        overflow-x: auto;
        overflow-y: auto;
      }
      .editor {
        position: absolute;
        left: 0;
        right: 0;
        height: 90%;
      }
      .status-bar {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        font-size: 0.8em;
      }
    </style>
  </head>
  <body ng-controller="DashboardController" ng-init="init()">
    <div class="container-fluid">
      <div class="col-sm-3 col-md-2 sidebar">
        <div class="current-user">
          <span class="glyphicon glyphicon-user"></span> {{request.user.username}}
          <a href="{% url 'logout' %}">{% trans 'Logout' %}</a>
        </div>
        <div class="dir-opener">
          <input type="text" ng-model="currentDir" class="form-control">
          <button class="btn btn-default" ng-click="openDir()">{% trans 'Open' %}</button>
        </div>
        <div class="filebrowser">
          <ul>
            <li ng-show="current.directories.length || current.files.length"><a href="#" ng-click="goBack()" onclick="return false" class="directory"><span class="glyphicon glyphicon-folder-close"></span> ..</a></li>
            <li ng-repeat="d in current.directories"><a href="#" ng-click="openDir(d.path)" onclick="return false" class="directory"><span class="glyphicon glyphicon-folder-close"></span> [[d.name]]</a></li>
            <li ng-repeat="f in current.files"><a href="#" ng-click="openFile(f.path)" onclick="return false" class="file"><span class="glyphicon glyphicon-file"></span> [[f.name]]</a></li>
          </ul>
        </div>
      </div>
      <div class="col-md-10">
        <div ng-show="opened_files.length" class="editor-wrapper">
          <ul class="nav nav-tabs" role="tablist">
            <li ng-class="{active: f.path==file.path}" ng-dblclick="closeFile($index)" ng-click="setFile($index)" ng-repeat="f in opened_files"><a href="#home" role="tab" onclick="return false" data-toggle="tab">[[f.name]]</a></li>
          </ul>
          <div on-save="saveFile()" ng-show="f.path==file.path" ng-repeat="f in opened_files" class="editor" id="[[f.name]]" contenteditable="contenteditable" ng-bind="f.content"></div>
          <div class="status-bar">
            opening file
          </div>
        </div>
      </div>
    </div>

    <div class="messages-wrapper">
      <div class="alert alert-[[m.type]] alert-dismissible" role="alert" ng-repeat="m in messages">
        <button type="button" class="close" ng-click="removeMessage($index)" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">{% trans 'Close' %}</span></button>
        [[m.text]]
      </div>
    </div>

    <script type="text/javascript" charset="utf-8" src="//cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/ace.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.19/angular.min.js"></script>
    <script type="text/javascript" src="{% static 'js/angular-resource.min.js' %}"></script>
    <script type="text/javascript" charset="utf-8">
      var app = angular.module('App', ['ngResource'])
      app.config(function($interpolateProvider){
        $interpolateProvider.startSymbol('[[')
        $interpolateProvider.endSymbol(']]')
      })

      app.directive('onSave', function() {
        return function(scope, elm, attrs) {
          function applySave() {
            scope.$apply(attrs.onSave);
          };

          var isCtrl = false

          elm.bind('keyup', function(evt) {
            if(evt.which == 17) isCtrl = false
          })

          elm.bind('keydown', function(evt){
            if(evt.which == 17) isCtrl=true;
            if(evt.which == 83 && isCtrl == true) {
                applySave()
                evt.preventDefault()
                return false;
            }
          })

        }
      })

app.directive('contenteditable', function() {
	/**
	* makes it possible to use <div contenteditable></div>
	* as input field for angular models
	*/
    return {
      restrict: 'A', // only activate on element attribute
      require: '?ngModel', // get a hold of NgModelController
      link: function(scope, element, attrs, ngModel) {
        if(!ngModel) return; // do nothing if no ng-model

        // Specify how UI should be updated
        ngModel.$render = function() {
          element.html(ngModel.$viewValue || '');
        };

        // Listen for change events to enable binding
        element.on('blur keyup change', function() {
          scope.$apply(read);
        });
        read(); // initialize

        // Write data to the model
        function read() {
          var html = element.html();
          // When we clear the content editable the browser leaves a <br> behind
          // If strip-br attribute is provided then we strip this out
          if( attrs.stripBr && html == '<br>' ) {
            html = '';
          }
          ngModel.$setViewValue(html);
        }
      }
    };
  });

      function DashboardController($scope, $http, $resource){
        $scope.currentDir = location.hash.replace('#', '')
        $scope.messages = []
        $scope.opened_files = []
        $scope.file = null
        $scope.current = {
          'directories': [],
          'files': []
        }

        var Directory = $resource('/api/v1.0/directory/?format=json&dir=:dir')
        var File = $resource('/api/v1.0/file/?format=json&path=:path')

        $scope.init = function(){
          if($scope.currentDir != ''){
            $scope.openDir()
          }
        }

        $scope.addMessage = function(type, text){
          $scope.messages.push({'type': type, 'text':text})
        }

        $scope.removeMessage = function(index){
          $scope.messages.splice(index, 1)
        }

        $scope.saveFile = function(){
          console.log('save called')
          $scope.file.$save()
        }

        $scope.openFile = function(path){
          for(var index in $scope.opened_files){
            if($scope.opened_files[index].path == path){
              return
            }
          }
          File.get({'path': path})
            .$promise.then(function(file){
              $scope.opened_files.push(angular.copy(file))
              $scope.setFile()
            }, function(data){
              $scope.addMessage('danger', 'File doesn\'t exist of you don\'t have access to it')
            })
        }

        $scope.initEditor = function(filename){
          var ext = filename.split('.')[filename.split('.').length - 1]
          var modes = {
            'py': 'python',
            'js': 'javascript',
            'rb': 'ruby',
            'html': 'html',
            'php': 'php'
          }
          setTimeout(function(){
            var editor = ace.edit(filename)
            editor.setOptions({
              fontSize: "11pt"
            })
            editor.setTheme("ace/theme/monokai")
            editor.getSession().setMode("ace/mode/" + modes[ext])
          }, 30)
        }

        $scope.setFile = function(index){
          if(typeof index == 'undefined'){
            index = $scope.opened_files.length - 1
          }
          $scope.file = $scope.opened_files[index]
          $scope.initEditor($scope.file.name)
        }

        $scope.closeFile = function(index){
          if($scope.file.name == $scope.opened_files[index].name){
            if($scope.opened_files.length > 1 && index == 0){
              $scope.file = $scope.opened_files[1]
            }else if($scope.opened_files.length > 1 && index != 0){
              $scope.file = $scope.opened_files[index - 1]
            }
          }
          $scope.opened_files.splice(index, 1)
        }

        $scope.goBack = function(){
          if($scope.currentDir != '/'){
            var dir_chain = $scope.currentDir.split('/')
            dir_chain.splice(dir_chain.length - 2, 2)
            $scope.openDir(dir_chain.join('/'))
          }
        }

        $scope.openDir = function(_dir){
          $scope.currentDir = _dir || $scope.currentDir
          if($scope.currentDir[$scope.currentDir.length-1] != '/'){
            $scope.currentDir += '/'
          }
          location.hash = $scope.currentDir
          Directory.get({'dir': $scope.currentDir})
            .$promise.then(function(data){
                $scope.current.directories = []
                $scope.current.files = []
                for(var index in data.children){
                  data.children[index].type === 'file'
                    ? $scope.current.files.push(data.children[index])
                    : $scope.current.directories.push(data.children[index])
                }
            }, function(data){
                $scope.addMessage('danger', 'Directory doesn\'t exist of you don\'t have access to it')
            })
        }

      }
    </script>
  </body>
</html>
